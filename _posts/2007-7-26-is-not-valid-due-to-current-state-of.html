---
layout: post
title: "Operation is not valid due to the current state of the object" After Setting A SharePoint LookupField Control ListId Property
categories: [.NET, SharePoint 2007, C#]
tags: [.NET, SharePoint 2007, C#]
---
<p>If you are trying to use the SharPoint LookupField control you will probably want to explicitly bind it to a list. You can do this in markup by passing the&#160;ListId attribute&#160;as follows:</P><font color=#0000ff size=2> <p></FONT><font color=#800000 size=2>SharePoint</FONT><font color=#0000ff size=2>:</FONT><font color=#800000 size=2>LookupField</FONT><font size=2> </FONT><font color=#ff0000 size=2>ID</FONT><font color=#0000ff size=2>="ContactTypeLookup"</FONT><font size=2> </FONT><font color=#ff0000 size=2>runat</FONT><font color=#0000ff size=2>="server"</FONT><font size=2> </FONT><font size=3><strong><font color=#ff0000>ListId</FONT><font color=#0000ff>="253C5ECA-D17B-460F-A16F-FEEE749D8B1F"</FONT></STRONG></FONT><font size=2> </FONT><font color=#ff0000 size=2>ControlMode</FONT><font color=#0000ff size=2>="New"</FONT><font size=2> </FONT><font color=#ff0000 size=2>FieldName</FONT><font color=#0000ff size=2>="ContactType"</FONT><font size=2> </FONT><font color=#0000ff size=2>/></P></FONT> <p>But what if you want to bind it to a list by name or set the&#160;list id in code? The first thing you might do is remove the ListId attribute in the markup and set the ListId property of the LookupField as so:</P><div style="FONT-SIZE: 10pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: courier new"><p style="MARGIN: 0px">ContactTypeLookup.ListId = <span style="COLOR: teal">SPContext</SPAN>.Current.Web.Lists[<span style="COLOR: maroon">"ContactTypes"</SPAN>].ID;</P></DIV><!--EndFragment--> <p>When you do you will get this lovely error:</P><p><a href="http://blog.mikeobrien.net/content/binary/Operationisnotvalidduetothecurrentstateo_CD84/image.png" atomicselection="true"><img style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" height=386 alt=image src="/content/d06694ca49e045fe9671546bfc54f1a1.png" width=539 border=0></A> </P><p>The problem is that the LookupField control uses the list defined in the ItemContext property (Which is a SPContext object). Using good ole' reflector you will find that this property originates from the base class Microsoft.SharePoint.WebControls.FormComponent. The ItemContext is lazily instantiated when the property is first accessed. <em>At that time</EM> <em>it creates a new SPContext based off the value set in the ListId property</EM>. Evidentially this property is accessed at some point <strong><em>before</EM></STRONG> the page loads thus instantiating the ItemContext before you have a chance to set the ListId. So setting ListId after that point does no good. What you can do however is give it a new ItemContext based off the list you want as follows:</P><font size=2> <p>ContactTypeLookup.ItemContext = </FONT><font color=#008080 size=2>SPContext</FONT><font size=2>.GetContext(</FONT><font color=#008080 size=2>HttpContext</FONT><font size=2>.Current, 0, </FONT><font color=#008080 size=2>SPContext</FONT><font size=2>.Current.Web.Lists[</FONT><font color=#800000 size=2>"ContactTypes"</FONT><font size=2>].ID, </FONT><font color=#008080 size=2>SPContext</FONT><font size=2>.Current.Web);</FONT></P><p>And make sure you remove the ListId attribute in the markup:</P><p><<font color=#800000 size=2>SharePoint</FONT><font color=#0000ff size=2>:</FONT><font color=#800000 size=2>LookupField</FONT><font size=2> </FONT><font color=#ff0000 size=2>ID</FONT><font color=#0000ff size=2>="ContactTypeLookup"</FONT><font size=2> </FONT><font color=#ff0000 size=2>runat</FONT><font color=#0000ff size=2>="server"</FONT><font size=2> </FONT><font color=#ff0000 size=2>ControlMode</FONT><font color=#0000ff size=2>="New"</FONT><font size=2> </FONT><font color=#ff0000 size=2>FieldName</FONT><font color=#0000ff size=2>="ContactType"</FONT><font size=2> </FONT><font color=#0000ff size=2>/></FONT></P><p>That's all there is too it!</P><p><a href="http://blog.mikeobrien.net/content/binary/Operationisnotvalidduetothecurrentstateo_CD84/image_3.png" atomicselection="true"><img style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" height=357 alt=image src="/content/67330a9155794976b3aed954da349e31.png" width=537 border=0></A></P>