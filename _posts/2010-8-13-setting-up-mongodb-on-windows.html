---
layout: post
title: Setting Up and Using MongoDB on Windows with .NET
tags: [MongoDB, .NET, NoRM]
---
<p>The following demonstrates how to setup and use MongoDB on Windows with .NET. Most of this info was taken from the <a href="http://www.mongodb.org/display/DOCS/Quickstart+Windows">quickstart</a> on the MongoDB site. </p>  <p><font size="3"><strong>Installation</strong></font></p>  <ol>   <li>Download and unzip the distro from <a href="http://www.mongodb.org/downloads">here</a>. </li>    <li>You can install MongoDB as a Windows Service or just run it manually with mongod.exe. The following flags provide MongoDB with the information it needs to run (Use --help for more parameters):      <br /><font face="Courier New">       <br />--logpath [Path]&#160;&#160; file to send all output to instead of stdout         <br />--logappend&#160;&#160;&#160;&#160;&#160;&#160;&#160; append to logpath instead of over-writing         <br />--dbpath [Path]&#160;&#160;&#160; directory for datafiles         <br />--directoryperdb&#160;&#160; each database will be stored in a separate directory</font>&#160;<font face="Courier New">        <br />--auth&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; run with security</font>&#160; <br />      <br />      <ol>       <li>To start manually, run mongod.exe with the above parameters:          <br />          <br /><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/623de562bffc44caaac08311b094cff6.png" width="677" height="90" />           <br /></li>        <li>To install as a Windows Service run mongod.exe with the above parameters and the following one, then start the service:          <br />          <br /><font face="Courier New">--install&#160;&#160;&#160; install mongodb service </font>          <br />          <br />&#160;<img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/7d5ea2ebdc624584b1e0b5ce8504c4e4.png" width="677" height="174" /> </li>     </ol>   </li> </ol>  <p><strong><font size="3">The Administrative Console</font></strong></p>  <p>You can interact with MongoDB using the administrative shell, mongo.exe: </p>  <p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/cb87d858da7d4bd1b06f78a7a13f3e75.png" width="509" height="119" /></p>  <p><font size="3"><strong>Securing the Server and Databases</strong></font></p>  <p>If you want to run in secure mode (With the --auth option above) you will need to setup an administrative user account (More info on this <a href="http://www.mongodb.org/display/DOCS/Security+and+Authentication">here</a>). If no administrative user is setup yet, you can access the server sans security (Via the admin console mongo.exe) on the same box the server process is running. A special database called &quot;admin&quot; is where you will add the administrative user account with the addUser method.&#160; </p>  <p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/4864350c96e84f8a8a55c0970a87c296.png" width="677" height="438" /> </p>  <p>Notice that after we added the admin user we got an access denied when we tried to enumerate the databases. This is because security is enabled after the first user is added. Once we authenticate with the auth method we can successfully enumerate the databases.</p>  <p>You can also add database specific users the same way you added the administrative user. Simply change to the database and add the user as above. You can specify if the user has read/write or read-only access as the third argument of addUSer:</p>  <p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/c6fae63f4dcf45d2a0b47890338b1fdc.png" width="677" height="222" /> </p>  <p><strong><font size="3">Basic Administrative Operations</font></strong></p>  <p>The following are some basic operations you can perform in the shell. Most of this info was taken from the <a href="http://www.mongodb.org/display/DOCS/dbshell+Reference">shell reference</a> and <a href="http://api.mongodb.org/js/overview-tree.html">api reference</a> on the MongoDB site. The shell is a javascript shell so you can use javascript directly in your commands. The <a href="http://api.mongodb.org/js/DB.html">DB object</a> represents the current db. The database is created automatically when you first add something to it (Like a user, collection, etc). There is no need to create it explicitly. Database names are case sensitive.</p>  <ul>   <li><font color="#0000ff" face="Courier New">db</font> - Displays the current database. </li>    <li><font color="#0000ff" face="Courier New">db.help()</font> - Displays the methods on the db object. </li>    <li><font color="#0000ff" face="Courier New">show dbs</font> - Shows a list of all the databases. </li>    <li><font color="#0000ff" face="Courier New">use [DatabaseName]</font> - Changes the current database.&#160; </li>    <li><font color="#0000ff" face="Courier New">show collections</font> - Shows all the collections in the database (Or &quot;tables&quot; if your coming from the RDBMS world. They aren't actually relational tables but they are the conceptual counterpart.) </li>    <li><font color="#0000ff" face="Courier New">db.auth(&quot;username&quot;, &quot;</font><a href="mailto:P@$$w0rd"><font color="#0000ff" face="Courier New">P@$$w0rd</font></a><font color="#0000ff" face="Courier New">&quot;)</font> - Login as a user. </li>    <li><font color="#0000ff" face="Courier New">show users</font> - Displays the users in a database. </li>    <li><font color="#0000ff" face="Courier New">db.addUser(&quot;username&quot;, P@$$w0rd, true)</font> - Adds a user to a database. The last parameter indicates if the user only has read-only access. Despite the &quot;add&quot; in the name, this method also <em>modifies </em>an existing user. So you can run this command against an existing user to change its password or make it read-only. </li>    <li><font color="#0000ff" face="Courier New">db.system.users.remove({user: &quot;username&quot;})</font> - Removes a user. </li> </ul>  <p>The <a href="http://api.mongodb.org/js/DBCollection.html">DBCollection object</a> allows you to work with collections. To access a collection simply type &quot;db&quot; then the collection name (IE db.[CollectionName].insert(...)). If the collection doesn't already exist it will be created automatically when an item is first added to it. There is no need to create it explicitly. Collection names are case sensitive.</p>  <ul>   <li><font color="#0000ff" face="Courier New">db.someCollection.find()</font> - Returns the items in the collection. Only displays 25 results, us the <font color="#0000ff" face="Courier New">it</font> command to continue enumerating. </li>    <li><font color="#0000ff" face="Courier New">db.someCollection.find().sort({City: -1})</font> - Returns the items in the collection filtered by criteria and it sorts it ascending or descending (-1 or 1).&#160;&#160;&#160; </li>    <li><font color="#0000ff" face="Courier New">db.someCollection.insert({Name: &quot;Kaleb Binkley&quot;})</font> - Inserts an item into the collection. </li>    <li><font color="#0000ff" face="Courier New">db.someCollection.find({City: &quot;Grand Junction&quot;})</font> - Returns the items in the collection filtered by criteria.&#160; </li>    <li><font color="#0000ff" face="Courier New">db.someCollection.update({AccountId:676}, {$set: {AccountId: 767}}, false, false)</font> - Updates an existing item (Or insert it if it doesn't exist, by setting the third parameter to true). See more <a href="http://www.mongodb.org/display/DOCS/Updating#Updating-update%28%29">here</a>. </li>    <li><font color="#0000ff" face="Courier New">db.someCollection.save(item)</font> - Shortcut for doing an update with upsert set to true. </li>    <li><font color="#0000ff" face="Courier New">db.someCollection.remove({AccountId: 767})</font> - Removes an item from a collection based on the criteria. </li>    <li><font color="#0000ff" face="Courier New">db.someCollection.drop()</font> - Deletes a collection. </li> </ul>  <p></p>  <p></p>  <p><strong><font size="3">Accessing MongoDB from .NET</font></strong></p>  <p>To access MongoDB from .NET we're going to use Andrew Theken's <a href="http://normproject.org/">norm library</a>. There are a couple of libraries you can use, see <a href="http://www.mongodb.org/display/DOCS/C+Sharp+Language+Center">here</a> for more info. You can download the NoRM source <a href="http://github.com/atheken/NoRM/downloads">here</a>, but currently you will have to compile it. May I suggest using <a href="http://github.com/phatboyg/nu">nu</a> instead? <a href="http://blog.mikeobrien.net/2010/07/using-gems-and-nu-for-package.html">Here</a> is some info on installing and using nu, I'd highly suggest going this route. Nu is really a slick approach to dependencies that is based on Ruby Gems. The gem name for NoRM is..... norm:</p>  <p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/3cd723014bbe4e3391a45d70cc9f81af.png" width="677" height="210" /> </p>  <p>Now you can reference this in your project. Andrew has a nice vid <a href="http://normproject.org/quickstart">here</a> to help get you going. Lets get started by connecting to a MongoDB server:</p>  <pre class="code"><span style="color: blue">static void </span>Main(<span style="color: blue">string</span>[] args)
{
    <span style="color: blue">const string </span>connectionString = 
        <span style="color: #a31515">&quot;mongodb://projecteuleruser:Pa$$w0rd@localhost/ProjectEuler&quot;</span>;

    <span style="color: blue">using </span>(<span style="color: blue">var </span>database = <span style="color: #2b91af">Mongo</span>.Create(connectionString))
    { 
    }

    <span style="color: #2b91af">Console</span>.ReadKey();
}</pre>

<p>The format of the connection string is &quot;mongodb://username:password@host/database&quot;. You can obviously leave out the &quot;username:password@&quot; if your hitting a non secure server. The database object is synonymous to the db object in the administrative console. Now lets start interacting with the database. First we will want to create an entity:</p>

<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">User
</span>{
    <span style="color: blue">public </span>User() { Id = <span style="color: #2b91af">Guid</span>.NewGuid(); }

    <span style="color: blue">public </span><span style="color: #2b91af">Guid </span>Id { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    <span style="color: blue">public string </span>Username { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    <span style="color: blue">public string </span>Password { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    <span style="color: blue">public string </span>Name { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    <span style="color: blue">public string </span>Email { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public override string </span>ToString()
    {
        <span style="color: blue">return string</span>.Format(<span style="color: #a31515">&quot;Username: {0}, Password: {1}, Name: {2}, Email: {3}&quot;</span>,
            Username,
            Password,
            Name,
            Email);
    }
}</pre>
<a href="http://11011.net/software/vspaste"></a>In the above entity we have a guid &quot;Id&quot; field, which is a required convention. Also it has a parameterless constructor, another requirement. We are generating the guid automatically in the constructor so that new entities are set to go. The overridden ToString() is not important, just for demo purposes. Now we will work with the User collection:&#160; <pre class="code"><span style="color: blue">using </span>(<span style="color: blue">var </span>database = <span style="color: #2b91af">Mongo</span>.Create(connectionString))
{
    <span style="color: blue">var </span>users = database.GetCollection&lt;<span style="color: #2b91af">User</span>&gt;();

    users.Find().ForEach(users.Delete);

    users.Save(<span style="color: blue">new </span><span style="color: #2b91af">User
                    </span>{
                        Username = <span style="color: #a31515">&quot;ldebroglie&quot;</span>,
                        Email = <span style="color: #a31515">&quot;louis.debroglie@paris-sorbonne.fr&quot;</span>,
                        Name = <span style="color: #a31515">&quot;Louis De Broglie&quot;</span>,
                        Password = <span style="color: #a31515">&quot;wavemechanics&quot;</span>.Hash(<span style="color: #a31515">&quot;ldebroglie&quot;</span>)
                    });

    users.Save(<span style="color: blue">new </span><span style="color: #2b91af">User
                    </span>{
                        Username = <span style="color: #a31515">&quot;wheisenberg&quot;</span>,
                        Email = <span style="color: #a31515">&quot;werner.heisenberg@uni-muenchen.de&quot;</span>,
                        Name = <span style="color: #a31515">&quot;Werner Heisenberg&quot;</span>,
                        Password = <span style="color: #a31515">&quot;matrixmechanics&quot;</span>.Hash(<span style="color: #a31515">&quot;wheisenberg&quot;</span>)
                    });

    users.Find().ForEach(<span style="color: #2b91af">Console</span>.WriteLine); 

    <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Authenticated: {0}&quot;</span>, 
                      (users.AsQueryable().
                             Any(u =&gt; u.Username == <span style="color: #a31515">&quot;wheisenberg&quot; </span>&amp;&amp; 
                                      u.Password == <span style="color: #a31515">&quot;wavemechanics&quot;</span>.Hash(<span style="color: #a31515">&quot;wheisenberg&quot;</span>))));
}</pre>
<a href="http://11011.net/software/vspaste"></a>

<p>If the ProjectEuler database or User collection is not already created, they will be automatically created when an action is performed on the User collection. As an aside, the example above uses a couple of <a href="http://gist.github.com/523841">extension methods that are not shown</a>. In the above example you can see how we are using the Find method (When we are clearing the collection and enumerating the users) and Linq (When authenticating the user); its up to you how you want to do it. In order to use Linq directly on the collection you will need to make the context switch by calling AsQuerable. The Save method will do an upsert; inserting if new, updating if it exists. Running the application produces the following output (The full code listing can be found <a href="http://gist.github.com/523856">here</a>):</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/22334fc1b57d49859a4292ff2b98e12d.png" width="677" height="114" /> </p>

<p></p>

<p>Going back to our administrative console we can see the new collection and its items:</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/blog/images/afd3b404aa884214814b825f711d24db.png" width="677" height="186" /> </p>

<p><strong><font size="3">Conclusion</font></strong></p>

<p>Document databases have a lot of promise, filling a niche that an RDBMS has been traditionally filling (But shouldn't have been). Some other document databases include <a href="http://couchdb.apache.org/">CouchDB</a> (With a <a href="http://blog.couch.io/post/619774280/i-use-couchdb-enjoy-our-latest-rap-about-the">sweet rap video</a>) and <a href="http://ravendb.net/">RavenDB</a>. Check out the <a href="http://groups.google.com/group/norm-mongodb">NoRM group page</a> to get involved with that project. </p>  