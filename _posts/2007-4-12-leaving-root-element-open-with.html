--
layout: post
title: Leaving the root element open with the XmlTextWriter
categories: [XML/XSL, VB.NET, .NET, C#]
tags: [XML/XSL, VB.NET, .NET, C#]
--
<P>So I am trying to write log information to an XML document using the XmlTextWriter.  When it reaches a certian size I want it closed out and archived. What I mean by "closed out" is that while the log file is "open" the root element is not closed so that I can keep adding entries over a period of time. In other words:</P>
<P><FONT face="Courier New" color=#006400><?xml version="1.0"?><BR><log><BR>    <entry date="1/1/2007">Yada yada yada</entry><BR>    <entry date="1/1/2007">Yada yada yada</entry><BR>    ...</FONT></P>
<P><BR>Then once its full I will write the closing root element and rename it: </P>
<P><FONT face="Courier New" color=#006400><?xml version="1.0"?><BR><log><BR>    <entry date="1/1/2007">Yada yada yada</entry><BR>    <entry date="1/1/2007">Yada yada yada</entry><BR>    ...<BR>    <entry date="1/1/2007">Yada yada yada</entry><BR></log></FONT></P>
<P>Well the XmlTextWriter automatically closes out all open elements when you close it. Looking in Reflector reveals what is happening behind the scenes:</P>
<P><SPAN style="FONT-SIZE: 11px; COLOR: black; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent"><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">public</SPAN> <SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">override</SPAN> <SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">void</SPAN> Close()<BR>{<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">   try</SPAN><BR>   {<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">      this</SPAN>.AutoCompleteAll();<BR>   }<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">   catch </SPAN>{}<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">   finally</SPAN><BR>   {<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">      this</SPAN>.currentState <SPAN style="FONT-SIZE: 11px; COLOR: red; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">=</SPAN> State.Closed;<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">      this</SPAN>.textWriter.Close();<BR>   }<BR>}</SPAN></P>
<P>First the AutoCompleteAll() method is called, then the underlying stream is closed. The AutoCompleteAll() method is as follows:</P>
<P><SPAN style="FONT-SIZE: 11px; COLOR: black; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent"><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">private</SPAN> <SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">void</SPAN> AutoCompleteAll()<BR>{<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">   if</SPAN> (<SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">this</SPAN>.flush)<BR>   {<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">      this</SPAN>.FlushEncoders();<BR>   }<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">   while</SPAN> (<SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">this</SPAN>.top > 0)<BR>   {<BR><SPAN style="FONT-SIZE: 11px; COLOR: blue; FONT-FAMILY: Courier New; BACKGROUND-COLOR: transparent">      this</SPAN>.WriteEndElement();<BR>   }<BR>}</SPAN></P>
<P>Doesent look like there is any official way to explicitly close only the elements you want to close, its just automatically done for you when you close the writer. The only work around I could figure out is to explicitly close the elements I want closed, then close the base stream (Not the XmlTextReader). This works but IMO its a little hackey since the code in the Close() method could potentially change in the future and you could end up circumventing some code that you might want executed when your done with the reader.</P>