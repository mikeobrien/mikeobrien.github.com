---
layout: post
title: Creating a self signed wildcard certificate for IIS7
tags: [SSL, IIS 7, .NET 2.0]
redirect_from:
  - /blog/2008/09/creating-self-signed-wildcard.html
---

<b><i>UPDATE: <a href="http://www.iis.net/learn/get-started/whats-new-in-iis-8/iis-80-server-name-indication-sni-ssl-scalability">IIS 8.0 and higher supports Server Name Indication</a> which allows you to bind multiple SSL certs to a single IP.</i></b>

<p>Recently I had the need to setup multiple SSL enabled sites on my local machine for development. These sites all had the same root domain but differed by sub domain. Traditionally you need to have a certificate and an IP address per SSL binding because of a <a href="http://support.microsoft.com/kb/187504">"chicken or the egg" problem resolving the host headers in an encrypted HTTP conversation</a>. If you have multiple sites with a common root domain that require SSL you can get around this limitation by using a wildcard certificate for all those sites. </p>

<p>So first I setup mappings in my hosts file (<SystemRoot>\System32\drivers\etc\hosts) as follows:</p>

    <p><font size="2" face="Courier New"># SomeSite Dev Mappings     <br />127.0.0.1&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; www.dev.somesite.net      <br />127.0.0.1&#160;&#160;&#160;&#160; services.dev.somesite.net      <br />127.0.0.1&#160;&#160;&#160;&#160;&#160;&#160;&#160; admin.dev.somesite.net</font>    <br />

<br />Next I need to create a self signed wildcard certificate. If you tried the <a href="http://weblogs.asp.net/scottgu/archive/2007/04/06/tip-trick-enabling-ssl-on-iis7-using-self-signed-certificates.aspx">self signed cert "feature" in IIS7</a> you probably quickly discovered that it is pretty much worthless since you cannot define the common name (CN), it's automatically set to the host name (Why does MS have a habit of giving you a powerful, feature rich car that can only make right turns?). One way to get around this is to generate your self signed cert with a tool and add it to the local machine store. IIS6 ships with a util called selfssl but this requires you to install the <a href="http://www.microsoft.com/downloads/details.aspx?familyid=56FC92EE-A71A-4C73-B628-ADE629C89499&displaylang=en">IIS6 ResKit</a> (See more about that <a href="http://codeforeternity.com/blogs/technology/archive/2008/02/15/creating-self-signed-ssl-certificates-on-iis-6-0-and-windows-server-2003.aspx">here</a>). While this works, it bothers me to install tools from a previous version of IIS to accomplish this. Shouldn't the newer version of IIS do more than it's predecessor? One other alternative I found on the <a href="http://en.wikipedia.org/wiki/Internets">internets</a> is to use the <a href="http://msdn.microsoft.com/en-us/library/bfsktky3.aspx">certificate creation tool</a> that ships with the <a href="http://www.microsoft.com/downloads/details.aspx?familyid=fe6f2099-b7b4-4f47-a244-c96d69c35dec&displaylang=en">.NET 2.0 SDK</a>. For some reason this "feels" better than using a tool from IIS6, probably just a mental thing... Plus you probably already have the SDK installed and are using it. </p>

<p>First create the self signed issuer certificate which will be set as a root cert authority (Fill in the red items):</p>

<p><font size="2" face="Courier New">"C:\Program Files\Microsoft SDKs\Windows\v6.0A\bin\makecert.exe" -n "CN=<font color="#ff0000">My Company Development Root CA</font>,O=<font color="#ff0000">My Company</font>,OU=<font color="#ff0000">Development</font>,L=<font color="#ff0000">Wallkill</font>,S=<font color="#ff0000">NY</font>,C=<font color="#ff0000">US</font>" -pe -ss Root -sr LocalMachine -sky exchange -m 120 -a sha256 -len 2048 -r</font></p>

<p><i>NOTE: SDKs are in "Program Files (x86)" on 64-bit installs (via rocjoe).</i></p>

<p>Next create a cert for your sites that is issued from this authority. You must specify the common name (CN=<IssuerName>) you entered above in the issuer name field below (-in <IssuerName>). Also I'm creating a wildcard certificate that will serve all sites with the dev.somesite.net root domain as this is a requirement to use host headers. If I add other sites in the future with a different subdomain I can choose this certificate and all is good. Specifying an asterisk as the subdomain will signify this (Fill in the red items):</p>


<p><font size="2" face="Courier New">"C:\Program Files\Microsoft SDKs\Windows\v6.0A\bin\makecert.exe" -n "CN=<font color="#ff0000"><font color="#000000">*.</font>dev.somesite.net</font>" -pe -ss My -sr LocalMachine -sky exchange -m 120 -in "<font color="#ff0000">My Company Development Root CA</font>" -is Root -ir LocalMachine -a sha256 -eku 1.3.6.1.5.5.7.3.1</font></p>  <p>You should now see this cert show up in the IIS manager on the "Server Certificates" page:</p>  <p><a href="http://blog.mikeobrien.net/content/binary/WindowsLiveWriter/Creatingaselfsignedwildcardcertificatefo_C165/image_2.png"><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" src="/blog/images/fda667bc52634e16a90986fb21b994f6.png" width="537" height="161" /></a> </p>


<b><i>UPDATE: You can now set the SSL host header in IIS Manager as of IIS 8.0.</i></b>

<p>Now again, MS gets you part of the way there in the UI but not all the way. As in IIS6 (SP1+) you cannot specify a host header for SSL bindings in the IIS7 UI because of, as mentioned above, <a href="http://support.microsoft.com/kb/187504">issues with resolving the host headers in an encrypted HTTP request</a>. But since we are using a wildcard certificate these issues are moot and IIS can do it but we have to configure it through the command line with the <a href="http://learn.iis.net/page.aspx/114/getting-started-with-appcmdexe/">new appcmd util</a>. The following command must be executed on each site that requires SSL. This command will create the SSL binding and set the host header. Make sure you specify the correct site name and host header for each site (In red):</p>  <p><font size="2" face="Courier New">C:\Windows\System32\inetsrv\appcmd set site /site.name:<font color="#ff0000">MySite</font> /+bindings.[protocol='https',bindingInformation='*:443:<font color="#ff0000">www.dev.somesite.net</font>']</font></p>  <p>Next go to the site bindings and you'll now see an SSL binding with a host header defined (Before this field would be disabled for SSL). You will need to select the the wildcard certificate you created earlier in the cert drop down and save your changes.</p>  <p><a href="http://blog.mikeobrien.net/content/binary/WindowsLiveWriter/Creatingaselfsignedwildcardcertificatefo_C165/image_6.png"><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" src="/blog/images/e0b79ecd8c03493fbd85cf9c56c52648.png" width="571" height="395" /></a></p>
