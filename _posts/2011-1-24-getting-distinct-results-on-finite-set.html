---
layout: post
title: Getting Distinct Results on a Finite Set of Columns or Projections
categories: [TSQL, SQL]
tags: [TSQL, SQL]
---
<p>I have a situation where I need to return a result set that is distinct on only a few columns or projections. The DISTINCT keyword does not fit the bill as it applies to the entire projection. Before we explore this lets start with some sample data in a table we'll call Contacts.</p>  <p><font face="Consolas">id&#160; email&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; name</font>     <br /><font face="Consolas">--&#160; -------------------&#160; -------</font>     <br /><font face="Consolas">1&#160;&#160; foxydog@yahoo.com&#160;&#160;&#160; Bob</font>    <br /><font face="Consolas">2&#160;&#160; foxydog@yahoo.com&#160;&#160;&#160; Robert</font>     <br /><font face="Consolas">3&#160;&#160; foxydog@yahoo.com&#160;&#160;&#160; Dick</font>     <br /><font face="Consolas">4&#160;&#160; william@hotmail.com&#160; Bill</font></p>  <p>In this example we want to get distinct records by email address, discarding duplicate records (As in this context they are not important). There are a couple of ways to approach this. You could do a GROUP BY on email and an aggregate the other fields (Like MAX) but this could mess things up if the other columns are related somehow (Like an address for example, you could get mismatched street, city, state and zip). You could also do a WHERE id IN on a sub query that does group by on email and a max on id which would solve the problem of mismatched columns:</p>  <p><font face="Consolas">SELECT * FROM Contacts</font>     <br /><font face="Consolas">WHERE id IN (SELECT MAX(id) FROM Contacts GROUP BY email)</font></p>  <p>I don't like this however because it requires two table scans (BTW I have indexes on id and email):</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/content/44874ba004df4c2a9cb600b9e6f090c5.png" width="796" height="182" /></p>  <p>Another option is to use the ROW_NUMBER aggregate and PARTITION BY. You can partition by the columns or projections you choose (And I say &quot;projections&quot; because it doesn't strictly have to be a column name, it could be LEN(email) for example). So we could say the following:</p>  <p><font face="Consolas">SELECT *</font>     <br /><font face="Consolas">FROM (SELECT *, </font>    <br /><font face="Consolas">&#160;&#160;&#160;&#160;&#160; ROW_NUMBER() OVER(PARTITION BY email ORDER BY email) PartitionId </font>    <br /><font face="Consolas">&#160;&#160;&#160;&#160;&#160; FROM Contacts) T</font></p>  <p>This returns the following:</p>  <p><font face="Consolas">id&#160; email&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; name&#160;&#160;&#160;&#160; PartitionId</font>     <br /><font face="Consolas">--&#160; -------------------&#160; -------&#160; -----------</font>     <br /><font face="Consolas">1&#160;&#160; foxydog@yahoo.com&#160;&#160;&#160; Bob&#160;&#160;&#160;&#160;&#160; 1</font>     <br /><font face="Consolas">2&#160;&#160; foxydog@yahoo.com&#160;&#160;&#160; Robert&#160;&#160; 2</font>     <br /><font face="Consolas">3&#160;&#160; foxydog@yahoo.com&#160;&#160;&#160; Dick&#160;&#160;&#160;&#160; 3</font>     <br /><font face="Consolas">4&#160;&#160; william@hotmail.com&#160; Bill&#160;&#160;&#160;&#160; 1</font></p>  <p>Notice how the row numbers restart (PartitionId) when the email address changes? We can then take this one step further and only return records with a partition id of 1 giving us a distinct result set:</p>  <p><font face="Consolas">SELECT *</font>     <br /><font face="Consolas">FROM (SELECT *, </font>    <br /><font face="Consolas">&#160;&#160;&#160;&#160;&#160; ROW_NUMBER() OVER(PARTITION BY email ORDER BY email) PartitionId </font>    <br /><font face="Consolas">&#160;&#160;&#160;&#160;&#160; FROM Contacts) T</font>     <br /><font face="Consolas">WHERE PartitionId = 1</font></p>  <p>This returns the following:</p>  <p><font face="Consolas">id&#160; email&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; name&#160;&#160;&#160;&#160; PartitionId</font>     <br /><font face="Consolas">--&#160; -------------------&#160; -------&#160; -----------</font>     <br /><font face="Consolas">1&#160;&#160; foxydog@yahoo.com&#160;&#160;&#160; Bob&#160;&#160;&#160;&#160;&#160; 1</font>     <br /><font face="Consolas">3&#160;&#160; william@hotmail.com&#160; Bill&#160;&#160;&#160;&#160; 1</font></p>  <p>And voila! Distinct on only one column. Even though this solution requires a bit more TSQL, the execution plan looks much nicer as we are only doing one table scan:</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/content/6c713e12e1574d8c8e408a7675b1e697.png" width="838" height="88" /></p>  