---
layout: post
title: Step by Step Installation Of Subversion Over Apache/SSL Authenticating through Active Directory (SSPI)
tags: [SSL, Subversion, Apache, Active Directory]
---
<P>The following is a step by step installation of Subversion over Apache and SSL authenticating through an Active Directory server or local server accounts. BTW, I'm by no means an Apache guru so please leave a comment if I'm missing anything. And thanks to a bunch of people who I cant remember who posted info on the web that helped in compiling these steps! :)</P>
<OL>
<LI>Install the latest CollabNet Win32 distribution found <A href="http://downloads.open.collab.net/collabnet-subversion.html">here</A>. 
<OL>
<LI>Make sure that only the Apache (MOD_DAV_SVN) component is checked. <BR><A href="http://blog.mikeobrien.net/content/binary/StepbyStepInstallationOfSubversionOverAp_11F69/image.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=391 alt=image src="/content/932de7a5d0c8460aa89dab9be31d333b.png" width=507 border=0></A> 
<LI>Set the Apache configuration. You can set an arbitrary http port for now; it will change&#160;when SSL is setup.&#160; Also remember to check the "Install Apache ... as a Windows Service" checkbox. The other two options should be set accordingly. <BR><A href="http://blog.mikeobrien.net/content/binary/StepbyStepInstallationOfSubversionOverAp_11F69/image_3.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=391 alt=image src="/content/3644b91826b44eff9812302b5c49e8c5.png" width=507 border=0></A> </LI></OL>
<LI>Create a test repository 
<OL>
<LI>Open a command prompt and run the following command from the CollabNet installation folder (C:\Program Files\CollabNet Subversion Server\) to create a test repository: <BR><FONT face="Courier New"><STRONG>svnadmin create d:\temp\Repos\mysweetapp</STRONG></FONT> </LI></OL>
<LI>Test Connectivity 
<OL>
<LI>Start the Apache service; it should be called Apache2. 
<LI>Browse to the test repository at <A href="http://localhost:1984/mysweetapp">http://localhost:1984/mysweetapp</A> with a Subversion client and create a folder to verify that everything is setup correctly. </LI></OL>
<LI>Install and Configure the SSPI module 
<OL>
<LI>Download the SSPI module from&#160;<A href="http://sourceforge.net/project/showfiles.php?group_id=162518">here</A>. You will want to match the major and minor Apache build with the version number trailing the SSPI module version number. For example mod_auth_sspi-1.0.4-<STRONG><FONT color=#ff0000>2.0</FONT></STRONG>.58.zip would be for Apache <FONT color=#ff0000><STRONG>2.0</STRONG></FONT>.x and mod_auth_sspi-1.0.4-<STRONG><FONT color=#ff0000>2.2</FONT></STRONG>.2.zip would be for Apache <STRONG><FONT color=#ff0000>2.2</FONT></STRONG>.x (Thanks to <A href="http://blog.pengoworks.com/">Dan Switzer</A> for <A href="http://blog.pengoworks.com/index.cfm/2007/11/1/Configuring-Windows-Authentication-with-Apache-22x-and-Subversion">pointing this out</A>, I totally missed that!). After unzipping the contents if the zip, copy the mod_auth_sspi.so (In the bin folder) into the Apache modules folder (C:\Program Files\CollabNet Subversion Server\httpd\modules). 
<LI>Open the httpd.conf file in the Apache configuration folder (C:\Program Files\CollabNet Subversion Server\httpd\conf) 
<LI>Add the following line to (Or uncomment it in) the Apache configuration file (httpd.conf) in the LoadModule section: <BR><FONT face="Courier New"><STRONG>LoadModule sspi_auth_module modules/mod_auth_sspi.so</STRONG></FONT> 
<LI>Add the following settings, under "# Active Directory Auth", to the location section. Be sure to specify the SSPIDomain which can be an AD domain or the local server name. If it is the local server name the local user accounts will be used to authenticate. You can use this option if there is no AD server. <BR><FONT face="Courier New"><STRONG>&#160;&#160;&#160;&#160; <Location /> <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; DAV svn <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SVNParentPath D:/Temp/Repos <BR>&#160; <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # Active Directory Auth <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AuthName "SVN Server" <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AuthType SSPI <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSPIAuth On <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSPIAuthoritative On <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSPIDomain&#160;localhost<BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSPIOfferBasic on <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Require valid-user <BR>&#160;&#160;&#160;&#160; </Location></STRONG></FONT> 
<LI>Restart the Apache2 service after the httpd.conf file has been saved. 
<LI>Perform the test noted in step #3 to test connectivity, this time logging in with a user from the domain specified above. 
<LI>Note that in TortoiseSVN&#160; you can check the "Save Authentication" checkbox to avoid having to repeatedly enter your credentials: <BR><A href="http://blog.mikeobrien.net/content/binary/StepbyStepInstallationOfSubversionOverAp_11F69/image_4.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=235 alt=image src="/content/ca8a717946854a7094693153c8a9f449.png" width=340 border=0></A> </LI></OL>
<LI>Configure SSL 
<OL>
<LI>Create the Certificate 
<OL>
<LI>Create an OpenSSL configuration file under the Apache bin folder (C:\Program Files\CollabNet Subversion Server\httpd\bin) called openssl.conf and set its contents as follows: <BR><FONT face="Courier New"><STRONG>&#160;&#160;&#160;&#160; [ v3_ca ] <BR>&#160;&#160;&#160;&#160; subjectKeyIdentifier = hash <BR>&#160;&#160;&#160;&#160; authorityKeyIdentifier = keyid:always,issuer:always <BR>&#160;&#160;&#160;&#160; basicConstraints = CA:true <BR>&#160;&#160;&#160;&#160; [ req ] <BR>&#160;&#160;&#160;&#160; default_bits&#160; = 1024 <BR>&#160;&#160;&#160;&#160; default_keyfile&#160; = svnserver.key <BR>&#160;&#160;&#160;&#160; distinguished_name = req_distinguished_name <BR>&#160;&#160;&#160;&#160; attributes&#160; = req_attributes <BR>&#160;&#160;&#160;&#160; x509_extensions = v3_ca&#160; <BR>&#160;&#160;&#160;&#160; string_mask&#160; = nombstr <BR>&#160;&#160;&#160;&#160; [ req_distinguished_name ]&#160; <BR>&#160;&#160;&#160;&#160; commonName&#160; = Common Name <BR>&#160;&#160;&#160;&#160; commonName_default = My Server Name <BR>&#160;&#160;&#160;&#160; [ req_attributes ]</STRONG></FONT> 
<LI>Open up a command prompt in the Apache bin folder (C:\Program Files\CollabNet Subversion Server\httpd\bin). 
<LI>Run the following command to generate the private key and certificate request files. Be sure to enter the ip address or DNS name of the server when prompted for the common name. Also remember the pass phrase you entered as it will be required for the following step. This will create a svnserver.csr and svnserver.key file in&#160;the Apache bin folder.<BR>&#160;&#160;&#160;&#160;&#160; <FONT face="Courier New" size=1><STRONG><FONT size=2>openssl req -config openssl.conf -new -out svnserver.csr</FONT> <BR><A href="http://blog.mikeobrien.net/content/binary/StepbyStepInstallationOfSubversionOverAp_11F69/image_5.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=216 alt=image src="/content/bc865657304749eab7313b61cf536639.png" width=640 border=0></A> </STRONG></FONT>
<LI>Remove the passphrase from the private key with the following command. Enter the passphrase you specified in the last step. <BR>&#160;&#160;&#160;&#160; <FONT face="Courier New" size=1><STRONG><FONT size=2>openssl rsa -in svnserver.key -out svnserver.key <BR></FONT><A href="http://blog.mikeobrien.net/content/binary/StepbyStepInstallationOfSubversionOverAp_11F69/image_6.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=88 alt=image src="/content/4f9d9868948640bf80c91ff2c24bf790.png" width=640 border=0></A> </STRONG></FONT>
<LI>Create the self signed certificate with the following command. The following command sets the certificate expiration to 20 years. <BR>&#160;&#160;&#160;&#160; <FONT face="Courier New"><STRONG>openssl x509 -in svnserver.csr -out svnserver.cert -req -signkey svnserver.key -days 7300</STRONG></FONT> <BR><A href="http://blog.mikeobrien.net/content/binary/StepbyStepInstallationOfSubversionOverAp_11F69/image_7.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=107 alt=image src="/content/f2db98b95c224a93b6264d34965c1961.png" width=640 border=0></A> 
<LI>Delete the svnserver.csr in the Apache bin folder. 
<LI>Copy the svnserver.key and svnserver.cert from the Apache bin folder to the Apache conf folder. </LI></OL>
<LI>Open the httpd.conf file in the Apache configuration folder (C:\Program Files\CollabNet Subversion Server\httpd\conf). 
<LI>Change the listen port to 443: <BR>&#160;&#160;&#160;&#160; <FONT face="Courier New"><STRONG>Listen 443</STRONG></FONT> 
<LI>Change the server name to include the SSL port, 443: <BR>&#160;&#160;&#160;&#160; <FONT face="Courier New"><STRONG>ServerName localhost:443</STRONG></FONT> 
<LI>Uncomment or add the load module directive for mod_ssl: <BR>&#160;&#160;&#160;&#160; <FONT face="Courier New"><STRONG>LoadModule ssl_module modules/mod_ssl.so</STRONG></FONT> 
<LI>Create or overwrite the following IfModule section so that it appears as follows: <BR><FONT face="Courier New"><STRONG>&#160;&#160;&#160;&#160; <IfModule mod_ssl.c> <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLEngine on <BR>&#160; <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLRandomSeed startup&#160;&#160; builtin <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLRandomSeed connect&#160;&#160; builtin <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLPassPhraseDialog&#160;&#160;&#160;&#160; builtin <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLSessionCache&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbm:logs/ssl_scache <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLSessionCacheTimeout&#160; 300 <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLMutex&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; default <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLCertificateFile&#160;&#160;&#160;&#160;&#160; conf\svnserver.cert <BR>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SSLCertificateKeyFile&#160;&#160; conf\svnserver.key&#160; <BR>&#160;&#160;&#160;&#160;&#160; </IfModule></STRONG></FONT> 
<LI>Restart the Apache2 service. 
<LI>Browse to <A href="https://localhost/mysweetapp">https://localhost/mysweetapp</A> and create a folder to test the configuration. 
<LI>Note that in TortoiseSVN you can permanently accept the certificate when this dialog appears. It is warning you that the issuer is not a trusted root authority. <BR><A href="http://blog.mikeobrien.net/content/binary/StepbyStepInstallationOfSubversionOverAp_11F69/image_8.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=151 alt=image src="/content/daad1731a3d4415abe7f3d7f187f3b88.png" width=454 border=0></A> </LI></OL></LI></OL>